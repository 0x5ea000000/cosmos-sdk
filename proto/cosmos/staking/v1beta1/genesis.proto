syntax = "proto3";
package cosmos.staking.v1beta1;

option go_package = "github.com/cosmos/cosmos-sdk/x/staking/types";

import "gogoproto/gogo.proto";
import "cosmos/staking/v1beta1/staking.proto";

// GenesisState defines the staking module's genesis state.
message GenesisState {
  // params defines all the paramaters of related to deposit.
  Params params = 1 [(gogoproto.nullable) = false];

  // last_total_power tracks the total amounts of bonded tokens recorded during
  // the previous end block.
  bytes last_total_power = 2 [
    (gogoproto.customtype) = "github.com/cosmos/cosmos-sdk/types.Int",
    (gogoproto.moretags)   = "yaml:\"last_total_power\"",
    (gogoproto.nullable)   = false
  ];

  // last_validator_powers is a special index that provides a historical list
  // of the last-block's bonded validators.
  repeated LastValidatorPower last_validator_powers = 3
      [(gogoproto.moretags) = "yaml:\"last_validator_powers\"", (gogoproto.nullable) = false];

  // delegations defines the validator set at genesis.
  repeated Validator validators = 4 [(gogoproto.nullable) = false];

  // delegations defines the delegations active at genesis.
  repeated Delegation delegations = 5 [(gogoproto.nullable) = false];

  // unbonding_delegations defines the unbonding delegations active at genesis.
  repeated UnbondingDelegation unbonding_delegations = 6
      [(gogoproto.moretags) = "yaml:\"unbonding_delegations\"", (gogoproto.nullable) = false];

  // redelegations defines the redelegations active at genesis.
  repeated Redelegation redelegations = 7 [(gogoproto.nullable) = false];

  bool exported = 8;

  // added newly added queues
  repeated MsgUnjail buffered_unjails = 8;
  repeated MsgCreateValidator buffered_create_validators = 9;
  repeated MsgEditValidator buffered_edit_validators = 10;

  // Current logic flow summary:
  // Current queues: "unbonding validator", "unbonding delegator", “redelegation"
  // Current Queue management
  // EndBlocker -> BlockValidatorUpdates -> DequeueAllMatureUBDQueue
  // EndBlocker -> BlockValidatorUpdates -> DequeueAllMatureRedelegationQueue
  // EndBlocker -> BlockValidatorUpdates -> UnbondAllMatureValidators 
  // EndBlocker -> BlockValidatorUpdates -> CompleteUnbonding -> RemoveUnbondingDelegation
  // EndBlocker -> BlockValidatorUpdates -> CompleteRedelegation -> RemoveRedelegation
  // BeginBlocker -> HandleValidatorSignature -> Jail
  // BeginBlocker -> HandleValidatorSignature -> Slash

  // Target logic flow summary:
  // Epoch -> BlockValidatorUpdates -> DequeueAllMatureUBDQueue
  // Epoch -> BlockValidatorUpdates -> DequeueAllMatureRedelegationQueue
  // Epoch -> BlockValidatorUpdates -> UnbondAllMatureValidators 
  // Epoch -> BlockValidatorUpdates -> CompleteUnbonding -> RemoveUnbondingDelegation
  // Epoch -> BlockValidatorUpdates -> CompleteRedelegation -> RemoveRedelegation
  // BeginBlocker -> HandleValidatorSignature -> Jail
  // BeginBlocker -> HandleValidatorSignature -> Slash

  // Current Msgs management
  // MsgUnjail -> instant validator update on condition met
  // MsgCreateValidator -> instant validator creation
  // MsgEditValidator -> instant validator update
  // MsgBeginRedelegate -> instant validator update and queue redelegation
  // MsgUndelegate -> instant pool balance update and queue undelegate
  // MsgDelegate -> instant delegation update
  // MsgWithdrawValidatorCommission -> instant
  // MsgWithdrawDelegatorReward -> instant

  // Target Msgs management
  // MsgUnjail -> queue validator update on condition met (BufferedMsgUnjailQueue)
  // MsgCreateValidator -> queue validator creation on condition met (BufferedMsgCreateValidatorQueue)
  // MsgEditValidator -> queue validator edit on condition met (BufferedMsgEditValidatorQueue)
  // MsgDelegate -> queue delegate (BufferedMsgDelegateQueue)
  // MsgBeginRedelegate -> queue redelegation (BufferedMsgRedelegationQueue) => move tokens between validators on epoch => After 3 weeks time, it should automatically remove redelegation entry for completion even though it's nott the end of epoch
  // MsgUndelegate -> queue undelegation (BufferedMsgUndelegateQueue) => move tokens to NotBondedPool and start unbonding period on epoch => After 3 weeks time, it should automatically unbond even though it’s not the end of epoch
  // MsgWithdrawValidatorCommission -> instant
  // MsgWithdrawDelegatorReward -> instant

  // The flow for an unbonding process would be:

  // 1. Submit MsgUnbond which adds it to DelegationChangeQueue
  // 2. Wait for end of Epoch
  // 3. Execute "BeginUnbonding", this adds it to UnbondingQueue
  // 4. Wait till end of Unbonding Period (3 weeks)
  // 5. Remove from UnbondingQueue

  // Changes to make for logic flow
  // BlockValidatorUpdates should be modified to ValidatorUpdates and should be called on Epoch
  // BeginBlocker -> HandleValidatorSignature run as it is and run ValidatorUpdates when it's updated on EndBlocker
  // to trigger tendermint validator set update instantly when Jail/Slash case.

  // Changes to make for Msgs flow
  // BufferMsgUnjail should be added to execute on next epoch: Add when condition met
  // BufferMsgCreateValidator should be added: send from user account to NotBondedPool and queue action
  // BufferMsgEditValidator should be added: queue action
  // BufferMsgDelegate should be added: queue action
  // BufferMsgBeginRedelegate should be added: queue action
  // BufferMsgUnDelegate should be added: queue action
}

// LastValidatorPower required for validator set update logic.
message LastValidatorPower {
  option (gogoproto.equal)           = false;
  option (gogoproto.goproto_getters) = false;

  // address is the address of the validator.
  string address = 1;

  // power defines the power of the validator.
  int64 power = 2;
}
